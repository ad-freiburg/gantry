version: "0"

services:
  qlever:
    image: niklas88/qlever
    volumes:
      - "{{EnvDir \"QLEVER_INDEX\" \"index\"}}:/index"
    environment:
      - INDEX_PREFIX=scientists-index
    depends_on:
      - build_index
    command: "-t"

steps:
  download_input:
    image: busybox
    volumes:
      - "{{TempDir \"input\"}}:/input"
    command:
      "wget -P /input/ http://qlever.cs.uni-freiburg.de/data/scientist-collection.zip"

  unzip_input:
    after:
      - download_input
    image: busybox
    volumes:
      - "{{TempDir \"input\"}}:/input"
    command:
      "unzip -d /input /input/scientist-collection.zip"

  build_index:
    after:
      - unzip_input
    image: niklas88/qlever
    volumes:
      - "{{TempDir \"input\"}}/scientist-collection:/input:ro"
      - "{{EnvDir \"QLEVER_INDEX\" \"index\"}}:/index"
    entrypoint: "IndexBuilderMain"
    command: "-l -i /index/scientists-index -f /input/scientists.nt -w /input/scientists.wordsfile.tsv -d /input/scientists.docsfile.tsv"

  wait_for_qlever:
    after:
      - qlever
    build:
      context: ./waitfor
    command: "waitfor http://qlever:7001"

  run_queries:
    after:
      - wait_for_qlever
    image: niklas88/qlever
    entrypoint: python3
    command: "/app/e2e/queryit.py /app/e2e/scientists_queries.yaml http://qlever:7001"
